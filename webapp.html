<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		<meta name="viewport" content="width=device-width, user-scalable=no">

		<style>
		body{font-family:Helvetica, Arial, sans-seriff; }

		textarea{
		  -webkit-appearance: none; -moz-appearance: none;
		  display: block;
		  margin: 0;
		  width: 100%; height: 50px;
		  line-height: 40px; font-size: 17px;
		  border: 1px solid #bbb;
		}
		 button {
		 -webkit-appearance: none; -moz-appearance: none;
		 display: block;
		 margin: 1.5em 0;
		 font-size: 1em; line-height: 2.5em;
		 color: #333;
		 font-weight: bold;
		 height: 2.5em; width: 100%;
		 background: #fdfdfd; background: -moz-linear-gradient(top, #fdfdfd 0%, #bebebe 100%); background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#fdfdfd), color-stop(100%,#bebebe)); background: -webkit-linear-gradient(top, #fdfdfd 0%,#bebebe 100%); background: -o-linear-gradient(top, #fdfdfd 0%,#bebebe 100%); background: -ms-linear-gradient(top, #fdfdfd 0%,#bebebe 100%); background: linear-gradient(to bottom, #fdfdfd 0%,#bebebe 100%);
		 border: 1px solid #bbb;
		 -webkit-border-radius: 10px; -moz-border-radius: 10px; border-radius: 10px;
		}

		</style>


		<title>meshed up</title>
	</head>

	<body>
		<h2>message</h2>
		<textarea id="message" rows="3" style="width:100%"  placeholder="Enter your message"></textarea>
		<button style="width:100%" id="send">Send</button>
		<h2>outbox</h2>
		<ul id="outbox"></ul>
		<h2>inbox</h2>
		<ul id="inbox"></ul>

<script type="text/javascript">

/*
 * OUTBOX STUFF
 */
document.getElementById( 'send' ).onclick = function() {

	var outStr = localStorage.getItem( 'outbox' ) || '';
	outStr += new Date().getTime() + ' ' + document.getElementById('name').value + '///' + document.getElementById('message').value + '\n';
	localStorage.setItem( 'outbox', outStr );
	updateOutboxView();
	checkOutbox();
	document.getElementById('message').value = '';
	//localStorage.setItem(
	//	new Date().getTime(),
	//	document.getElementById('message').value );
	//updateList();
};
function checkOutbox() {
	var outStr = localStorage.getItem( 'outbox' );
	if ( ! outStr ) {
		return;
	}
	var lines = outStr.split( /\n/ );
	for ( var i in lines ) {
		if ( lines[i].length === 0 ) {
			continue;
		}
		var ts = lines[ i ].substr( 0, lines[ i ].indexOf( ' ' ));
		var msg = lines[ i ].substr( lines[ i ].indexOf( ' ' ));
		sendMessage( ts, msg );
	}
}
function sendMessage( timestamp, message ) {
	var xhr = new XMLHttpRequest();
	var data = 'time=' + encodeURIComponent( timestamp ) +
		'&message=' + encodeURIComponent( message );

	xhr.onreadystatechange = function(){
	 	if ( xhr.readyState == 4){
	  		if ( xhr.status == 200 ) {
	   			removeOutboxItem( timestamp );
	  		}
 		}
	};

	xhr.open('POST', 'send', true);
	xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	xhr.setRequestHeader('If-Modified-Since', 'Sat, 1 Jan 2005 00:00:00 GMT');
	xhr.send(data);
}
function removeOutboxItem( timestamp ) {
	var outStr = localStorage.getItem( 'outbox' ) || '';
	var lines = outStr.split( /\n/ );
	for ( var i in lines ) {
		var ts = lines[ i ].substr( 0, lines[ i ].indexOf( ' ' ));
		if ( ts === timestamp ) {
			lines.splice( i, 1 );
			break;
		}
	}
	var newOutStr = lines.join('\n');
	localStorage.setItem('outbox', newOutStr);
	updateOutboxView();
}
function updateOutboxView() {
	var contentString = '';
	var outStr = localStorage.getItem( 'outbox' ) || '';
	var lines = outStr.split( /\n/ );
	for ( var i in lines ) {
		if ( lines[ i ].length === 0 ) {
			continue;
		}
		var ts = lines[ i ].substr( 0, lines[ i ].indexOf( ' ' ));
		var msg = lines[ i ].substr( lines[ i ].indexOf( ' ' ));
		contentString += '<li><b>' + ts + ' </b>' + msg + '</li>';
	}
	document.getElementById( 'outbox' ).innerHTML = contentString;
}

function doStuffForEach( entriesString, stuffFunction ) {
	if ( ! entriesString ) {
		return;
	}
	var lines = entriesString.split( /\n/ );
	for ( var i in lines ) {
		var ts = lines[ i ].substr( 0, lines[ i ].indexOf( ' ' ));
		var msg = lines[ i ].substr( lines[ i ].indexOf( ' ' ) + 1 );
		stuffFunction( ts, msg );
	}
}
/*
 * INBOX STUFF
 */



function updateInboxView() {
	var localStorageArray = new Array();
	var contentString = '';

	if (localStorage.length>0) {
	for (i=0;i<localStorage.length;i++){


	element=localStorage.getItem(localStorage.key(i))

	elesplit=element.split('///');

	if ( localStorage.key(i).length === 0 || element === 'outbox' ) {
		continue;
	}
	localStorageArray[i] = { time:localStorage.key(i), content:elesplit[0] };
	}
	}
	orderStorage = localStorageArray.sort(function(a,b) { return b.time - a.time } );

	for(var i in orderStorage)
	{
		if ( i.length === 0 || i === 'outbox' ) {
			continue;
		}
		var date = new Date(parseInt(orderStorage[i].time));
//		date.setHours(date.getHours() + 2); 
		var datereadable = date.getDate()+"/"+date.getMonth()+"/"+date.getFullYear()+" "+date.getHours()+":"+date.getMinutes();
		element=orderStorage[i].content.split('///');
		contentString += '<li><b>' + datereadable + ' </b>' + ' <i>'+ element[0] +'</i><br/> '+ element[1]+'</li>';
	}
	document.getElementById( 'inbox' ).innerHTML = contentString;
}

function onMessageDownload( msg, filename ) {
	if ( localStorage.getItem( filename ) === null ) {
		localStorage.setItem( filename, msg );
	}
	updateInboxView();
}
function onIndex( index ) {
        var lines = index.split( /\n/ );

	for(var k in localStorage){
		var l = 1;
		for ( var i in lines ) {
			var f = lines[i];
			if (f == k){ l = 0; }
		}
	if (l == 1){ 
	localStorage.removeItem(k);
	}
	}
updateInboxView();

	for ( var i in lines ) {
		var fname = lines[i];
		if ( localStorage.getItem( fname ) === null ) {
			//localStorage.setItem( ts, lines[i].substr(lines[i].indexOf(' ')) );
			downloadMessage( fname );
		}
	
	}

}
function downloadMessage(filename) {
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
			if (xhr.readyState == 4 && xhr.status == 200){
					onMessageDownload( xhr.responseText, filename );
			}
	}
	xhr.open( "GET", 'msg/'+filename, true);
	xhr.send();

}
function checkInbox() {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function(){
        if (xhr.readyState == 4 && xhr.status == 200){
            onIndex( xhr.responseText );
        }
    }
    xhr.open( "GET", 'index', true);
    xhr.send();
}

/*
 * INIT
 */

updateInboxView();
updateOutboxView();
window.setInterval( function(){
	checkInbox();
	checkOutbox();
}, 3000 );

</script>

	</body>
</html>
